---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PostCard from '../../components/PostCard.astro';
import Paginator from '../../components/Paginator.astro';
import { getPosts, type WPPost } from '../../data/wp';

export async function getStaticPaths() {
  const postsPerPage = 6;
  
  // Get total number of posts to calculate total pages
  const { totalPages } = await getPosts({ page: 1, perPage: postsPerPage });
  
  // Generate paths for all pages (starting from page 2, since page 1 is handled by index.astro)
  const paths: Array<{
    params: { page: string };
    props: { posts: WPPost[]; currentPage: number; totalPages: number };
  }> = [];
  
  for (let page = 2; page <= totalPages; page++) {
    const { items: posts } = await getPosts({ page, perPage: postsPerPage });
    paths.push({
      params: { page: page.toString() },
      props: { posts, currentPage: page, totalPages }
    });
  }
  
  return paths;
}

interface Props {
  posts: WPPost[];
  currentPage: number;
  totalPages: number;
}

const { posts, currentPage, totalPages } = Astro.props as Props;
---

<BaseLayout title={`Page ${currentPage} - nico.ar - Notes on Design & Tech`} description="Personal blog about design, technology, and user experience by Nicolas Zicarelli from Buenos Aires, Argentina.">
  <Header slot="header" />
  
  <div class="section py-2 mt-2 mb-2 mb-sm-3">
    <div class="row posts-grid gx-md-60 gy-4">
      {posts.map(post => (
        <div class="col-12 col-md-6 mb-4">
          <PostCard post={post} />
        </div>
      ))}
    </div>
    
    <Paginator 
      currentPage={currentPage} 
      totalPages={totalPages}
      baseUrl="/page"
    />
  </div>
  
  <!-- Script to save current page in sessionStorage when clicking article links -->
  <script define:vars={{ currentPage }}>
    document.addEventListener('DOMContentLoaded', () => {
      // Debug: log current page value
      console.log('Current page:', currentPage);
      
      // Save current page info when user clicks on article links
      const articleLinks = document.querySelectorAll('a[href^="/posts/"]');
      articleLinks.forEach(link => {
        link.addEventListener('click', () => {
          // Store the current page number for returning
          const returnUrl = currentPage === 1 ? '/' : `/page/${currentPage}`;
          console.log('Storing return URL:', returnUrl);
          sessionStorage.setItem('blog-return-page', returnUrl);
        });
      });
    });
  </script>
  
  <Footer slot="footer" />
</BaseLayout>
