---
import type { WPPost } from '../data/wp.ts';
import { getFeatured } from '../data/wp.ts';
import { formatDateEn, computeReadingTime, getExcerpt } from '../lib/utils.ts';
import CalendarIcon from '../assets/images/icon-calendar.svg?raw';
import ClockIcon from '../assets/images/icon-clock.svg?raw';

export interface Props {
  post: WPPost;
}

const { post } = Astro.props;

// Get categories from embedded data
const categories = post._embedded?.['wp:term']?.[0] || [];

// Get featured image using helper function
const featuredImage = getFeatured(post);

// Calculate reading time from content
const readingTime = computeReadingTime(post.content.rendered);

// Get clean excerpt with full length for JavaScript clamping
// The text-clamp.js will handle the responsive truncation
const excerpt = getExcerpt(post.excerpt.rendered || post.content.rendered, 500);
---

<a href={`/posts/${post.slug}`} class="card">
  <!-- Article thumbnail -->
  {featuredImage.src ? (
    <img 
      src={featuredImage.src} 
      alt={featuredImage.alt || post.title.rendered}
      class="card__thumb"
      loading="lazy"
      decoding="async"
    />
  ) : (
    <div class="card__thumb"></div>
  )}
  
  <!-- Categories/Pills -->
  {categories.length > 0 && (
    <div class="pills card__pills">
      {categories.slice(0, 3).map(category => (
        <span class="pill">{category.name}</span>
      ))}
    </div>
  )}
  
  <!-- Article title -->
  <h2 class="card__title pt-1 mt-2">
    {post.title.rendered}
  </h2>
  
  <!-- Meta information BELOW title -->
  <div class="card__meta">
    <span class="meta-item">
      <Fragment set:html={CalendarIcon} />
      <time datetime={post.date}>{formatDateEn(post.date)}</time>
    </span>
    <span class="meta-item">
      <Fragment set:html={ClockIcon} />
      <span class="meta-read">{readingTime} min</span>
    </span>
  </div>
  
  <!-- Excerpt -->
  <p class="card__excerpt post-excerpt-js" data-clamp="3" data-clamp-lg="4">
    {excerpt}
  </p>
</a>
